<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>メディア登録シート</title>
    <style>
      :root {
        --accent: #0052cc;
        --accent-light: #e6f0ff;
        --bg: #f4f6fb;
        --card: #ffffff;
        --border: #d9e2f3;
        --text: #142041;
        --muted: #5c637a;
        --danger: #d14343;
        --success: #1f8a70;
        --warning: #c17d0f;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Noto Sans JP', system-ui, -apple-system, BlinkMacSystemFont,
          'Segoe UI', sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
      }

      .page-header {
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: 20px clamp(16px, 4vw, 48px);
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
      }

      .header-text {
        max-width: 720px;
      }

      .eyebrow {
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
        margin: 0 0 4px;
      }

      .page-header h1 {
        margin: 0 0 8px;
        font-size: clamp(1.5rem, 3vw, 2rem);
      }

      .lead {
        margin: 0;
        color: var(--muted);
        line-height: 1.6;
      }

      .back-link {
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 8px 18px;
        text-decoration: none;
        color: var(--accent);
        font-weight: 600;
        background: var(--accent-light);
      }

      main {
        padding: clamp(16px, 4vw, 48px);
      }

      .sheet-card {
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 10px 30px rgba(0, 21, 64, 0.08);
        padding: clamp(16px, 4vw, 36px);
      }

      .sheet-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 12px;
      }

      .sheet-controls h2 {
        margin: 0;
        font-size: 1.3rem;
      }

      .secondary-button,
      .primary-button {
        border: none;
        border-radius: 999px;
        padding: 10px 20px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .secondary-button {
        background: transparent;
        color: var(--accent);
        border: 1px solid var(--accent);
      }

      .secondary-button:hover,
      .primary-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0, 82, 204, 0.2);
      }

      .primary-button {
        background: var(--accent);
        color: #fff;
        min-width: 160px;
      }

      .helper-text {
        margin: 12px 0 16px;
        color: var(--muted);
      }

      .sheet-wrapper {
        width: 100%;
        overflow-x: auto;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fdfefe;
      }

      .sheet-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 720px;
      }

      .sheet-table thead {
        background: var(--accent);
        color: #fff;
      }

      .sheet-table th,
      .sheet-table td {
        border: 1px solid var(--border);
        padding: 10px;
        text-align: left;
        vertical-align: top;
      }

      .sheet-table th {
        font-weight: 600;
      }

      .col-letter {
        display: block;
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        margin-bottom: 4px;
        opacity: 0.85;
      }

      .sheet-table input,
      .sheet-table textarea {
        width: 100%;
        border: none;
        background: transparent;
        font: inherit;
        resize: vertical;
        min-height: 32px;
      }

      .sheet-table textarea {
        min-height: 48px;
      }

      .sheet-table input:focus,
      .sheet-table textarea:focus {
        outline: 2px solid var(--accent-light);
        border-radius: 4px;
      }

      .actions {
        margin-top: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .notice {
        margin: 16px 0 0;
        padding: 12px 16px;
        border-radius: 12px;
        background: #fff8e1;
        color: #5a4200;
        border: 1px solid #ffe9a7;
      }

      .status {
        min-height: 24px;
        margin-top: 12px;
        font-weight: 600;
      }

      .status--error {
        color: var(--danger);
      }

      .status--success {
        color: var(--success);
      }

      .result-panel {
        margin-top: 32px;
        border-top: 1px dashed var(--border);
        padding-top: 24px;
      }

      .result-summary {
        margin-bottom: 12px;
        color: var(--text);
        font-weight: 600;
      }

      .result-table-wrapper {
        overflow-x: auto;
      }

      .result-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 560px;
      }

      .result-table th,
      .result-table td {
        border: 1px solid var(--border);
        padding: 8px 12px;
        text-align: left;
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .status-pill.success {
        background: rgba(31, 138, 112, 0.15);
        color: var(--success);
      }

      .status-pill.error {
        background: rgba(209, 67, 67, 0.15);
        color: var(--danger);
      }

      .status-pill.skipped {
        background: rgba(193, 125, 15, 0.15);
        color: var(--warning);
      }

      @media (max-width: 640px) {
        .sheet-table {
          min-width: 640px;
        }
      }
    </style>
  </head>
  <body>
    <header class="page-header">
      <div class="header-text">
        <p class="eyebrow">OTONARI API PORTAL</p>
        <h1>メディア登録専用シート</h1>
        <p class="lead">
          スプレッドシートに近い操作感で、アフィリエイターやメディア情報を入力できます。必要項目をA列からF列まで順番に入力し、「実行」ボタンでAPI登録を行ってください。
        </p>
      </div>
      <a id="back-link" class="back-link" href="./">ポータルトップへ戻る</a>
    </header>

    <main>
      <section class="sheet-card">
        <div class="sheet-controls">
          <h2>入力シート</h2>
          <button type="button" class="secondary-button" id="add-row-button">
            ＋ 行を追加
          </button>
        </div>
        <p class="helper-text">
          A列からF列まで順に「アフィリエイター / メディア名 / メディアURL / メディアカテゴリー / メディアタイプ / メディア説明」を入力してください。空行は自動的に無視されます。
        </p>
        <p class="helper-text">
          スプレッドシートで複数行をコピーしてここへ貼り付けると、表形式のまま自動で行が追加され、貼り付けた分だけ表示されます。
        </p>
        <div class="sheet-wrapper">
          <table class="sheet-table" aria-label="メディア登録データ">
            <thead id="sheet-head"></thead>
            <tbody id="media-grid-body"></tbody>
          </table>
        </div>
        <div class="actions">
          <button type="button" class="primary-button" id="execute-button">
            実行
          </button>
          <span id="row-count"></span>
        </div>
        <p class="notice" id="environment-warning" hidden>
          プレビュー環境のため実行できません。Google Apps Script のWebアプリとして開いた状態でご利用ください。
        </p>
        <p id="status-message" class="status" role="status" aria-live="polite"></p>
        <section id="result-panel" class="result-panel" hidden>
          <h3>処理結果</h3>
          <div id="result-summary" class="result-summary"></div>
          <div class="result-table-wrapper">
            <table class="result-table">
              <thead>
                <tr>
                  <th scope="col">行番号</th>
                  <th scope="col">ステータス</th>
                  <th scope="col">メディアID</th>
                  <th scope="col">メッセージ</th>
                </tr>
              </thead>
              <tbody id="result-body"></tbody>
            </table>
          </div>
        </section>
      </section>
    </main>

    <script>
      (function () {
        const templatePortalUrl = '<?= portalUrl ?>';
        const resolvedPortalUrl =
          templatePortalUrl && templatePortalUrl.indexOf('<?=') === -1
            ? templatePortalUrl
            : './';
        const columns = [
          {
            key: 'affiliateIdentifier',
            letter: 'A',
            label: 'アフィリエイター',
            placeholder: '例: 株式会社○○ / 山田太郎',
          },
          {
            key: 'mediaName',
            letter: 'B',
            label: 'メディア名',
            placeholder: '例: サンプルメディア',
          },
          {
            key: 'mediaUrl',
            letter: 'C',
            label: 'メディアURL',
            placeholder: 'https://example.com',
          },
          {
            key: 'mediaCategory',
            letter: 'D',
            label: 'メディアカテゴリー',
            placeholder: 'カテゴリ名またはID',
          },
          {
            key: 'mediaType',
            letter: 'E',
            label: 'メディアタイプ',
            placeholder: 'タイプ名またはID',
          },
          {
            key: 'mediaComment',
            letter: 'F',
            label: 'メディア説明',
            placeholder: 'メディアの概要や特色',
            multiline: true,
          },
        ];

        const tableHead = document.getElementById('sheet-head');
        const tableBody = document.getElementById('media-grid-body');
        const addRowButton = document.getElementById('add-row-button');
        const executeButton = document.getElementById('execute-button');
        const statusMessage = document.getElementById('status-message');
        const rowCountLabel = document.getElementById('row-count');
        const resultPanel = document.getElementById('result-panel');
        const resultSummary = document.getElementById('result-summary');
        const resultBody = document.getElementById('result-body');
        const environmentWarning = document.getElementById('environment-warning');
        const backLink = document.getElementById('back-link');

        if (backLink) {
          backLink.href = resolvedPortalUrl;
        }

        buildTableHead();
        const INITIAL_ROWS = 5;
        ensureRowCount(INITIAL_ROWS);

        const gasRunnerAvailable =
          typeof google === 'object' &&
          google.script &&
          typeof google.script.run === 'object';

        if (!gasRunnerAvailable && environmentWarning) {
          environmentWarning.hidden = false;
        }

        if (addRowButton) {
          addRowButton.addEventListener('click', () => {
            addRow();
          });
        }

        if (executeButton) {
          executeButton.addEventListener('click', handleExecute);
        }

        if (tableBody) {
          tableBody.addEventListener('paste', handlePaste, true);
        }

        function buildTableHead() {
          if (!tableHead) {
            return;
          }
          const headRow = document.createElement('tr');
          columns.forEach((column) => {
            const th = document.createElement('th');
            th.scope = 'col';
            const letter = document.createElement('span');
            letter.className = 'col-letter';
            letter.textContent = column.letter;
            const label = document.createElement('span');
            label.textContent = column.label;
            th.appendChild(letter);
            th.appendChild(label);
            headRow.appendChild(th);
          });
          tableHead.appendChild(headRow);
        }

        function addRow() {
          const rowNumber = tableBody.children.length + 1;
          const row = document.createElement('tr');
          row.dataset.rowNumber = rowNumber;

          columns.forEach((column) => {
            const cell = document.createElement('td');
            const input = column.multiline
              ? document.createElement('textarea')
              : document.createElement('input');
            if (!column.multiline) {
              input.type = 'text';
            }
            input.placeholder = column.placeholder || '';
            input.dataset.columnKey = column.key;
            input.setAttribute('aria-label', column.label + '（行' + rowNumber + '）');
            cell.appendChild(input);
            row.appendChild(cell);
          });

          tableBody.appendChild(row);
          updateRowCount();
          return row;
        }

        function ensureRowCount(count) {
          if (!tableBody) {
            return;
          }
          while (tableBody.children.length < count) {
            addRow();
          }
        }

        function collectRows() {
          return Array.from(tableBody.querySelectorAll('tr')).map((row, index) => {
            const rowNumber = Number(row.dataset.rowNumber) || index + 1;
            const data = { rowNumber: rowNumber };
            columns.forEach((column) => {
              const input = row.querySelector('[data-column-key="' + column.key + '"]');
              data[column.key] = input ? input.value.trim() : '';
            });
            return data;
          });
        }

        function hasValues(row) {
          return columns.some((column) => row[column.key]);
        }

        function handlePaste(event) {
          const target = event.target;
          if (
            !target ||
            !target.closest('tr') ||
            !target.dataset ||
            !target.dataset.columnKey
          ) {
            return;
          }

          const clipboardData = event.clipboardData || window.clipboardData;
          const text = clipboardData && clipboardData.getData('text');
          if (!text || text.indexOf('\t') === -1 && text.indexOf('\n') === -1) {
            return;
          }

          event.preventDefault();

          const startRowIndex = Array.from(tableBody.children).indexOf(
            target.closest('tr')
          );
          const startColumnIndex = columns.findIndex(
            (column) => column.key === target.dataset.columnKey
          );

          if (startRowIndex < 0 || startColumnIndex < 0) {
            return;
          }

          const matrix = text
            .split(/\r?\n/)
            .map((line) => line.split('\t'))
            .filter((row) => row.some((value) => value && value.trim() !== ''));

          if (!matrix.length) {
            return;
          }

          ensureRowCount(startRowIndex + matrix.length);

          matrix.forEach((rowValues, rowOffset) => {
            const targetRow = tableBody.children[startRowIndex + rowOffset];
            if (!targetRow) {
              return;
            }
            rowValues.forEach((value, colOffset) => {
              const column = columns[startColumnIndex + colOffset];
              if (!column) {
                return;
              }
              const input = targetRow.querySelector(
                '[data-column-key="' + column.key + '"]'
              );
              if (input) {
                input.value = value.trim();
              }
            });
          });
        }

        function handleExecute() {
          const rows = collectRows();
          const filledRows = rows.filter(hasValues);

          if (!filledRows.length) {
            setStatus('入力済みの行がありません。', 'error');
            return;
          }

          setStatus('送信中です…', null);
          setLoading(true);

          sendRows(filledRows)
            .then((result) => {
              showResults(result || {});
              if (result && result.summary && result.summary.total > 0) {
                setStatus('処理が完了しました。', 'success');
              } else {
                setStatus('送信対象の行がありませんでした。', 'error');
              }
            })
            .catch((error) => {
              const message =
                (error && error.message) || error || '実行中にエラーが発生しました。';
              setStatus(message, 'error');
            })
            .finally(() => {
              setLoading(false);
            });
        }

        function sendRows(rows) {
          return new Promise((resolve, reject) => {
            if (!gasRunnerAvailable) {
              reject(
                new Error(
                  '実行環境が見つかりませんでした。Google Apps Script のWebアプリからアクセスしてください。'
                )
              );
              return;
            }
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .registerMediaFromWeb(rows);
          });
        }

        function showResults(result) {
          if (!resultPanel || !resultSummary || !resultBody) {
            return;
          }

          const summary = result.summary || {
            total: 0,
            success: 0,
            skipped: 0,
            errors: 0,
          };
          resultSummary.textContent = `総件数: ${summary.total} / 成功: ${summary.success} / スキップ: ${summary.skipped} / エラー: ${summary.errors}`;

          resultBody.innerHTML = '';
          const rows = Array.isArray(result.results) ? result.results : [];
          if (!rows.length) {
            const emptyRow = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 4;
            cell.textContent = '処理対象の行がありません。';
            emptyRow.appendChild(cell);
            resultBody.appendChild(emptyRow);
          } else {
            rows.forEach((item) => {
              const tr = document.createElement('tr');
              const rowCell = document.createElement('td');
              rowCell.textContent = item.rowNumber || '';
              tr.appendChild(rowCell);

              const statusCell = document.createElement('td');
              const pill = document.createElement('span');
              const statusKey = item.status || 'skipped';
              pill.className = 'status-pill ' + statusKey;
              pill.textContent = formatStatus(statusKey);
              statusCell.appendChild(pill);
              tr.appendChild(statusCell);

              const mediaIdCell = document.createElement('td');
              mediaIdCell.textContent = item.mediaId || '';
              tr.appendChild(mediaIdCell);

              const messageCell = document.createElement('td');
              messageCell.textContent = item.message || '';
              tr.appendChild(messageCell);

              resultBody.appendChild(tr);
            });
          }

          resultPanel.hidden = false;
        }

        function formatStatus(status) {
          switch (status) {
            case 'success':
              return '成功';
            case 'error':
              return 'エラー';
            default:
              return 'スキップ';
          }
        }

        function setStatus(message, type) {
          if (!statusMessage) {
            return;
          }
          statusMessage.textContent = message || '';
          statusMessage.classList.remove('status--error', 'status--success');
          if (type === 'error') {
            statusMessage.classList.add('status--error');
          } else if (type === 'success') {
            statusMessage.classList.add('status--success');
          }
        }

        function setLoading(isLoading) {
          if (!executeButton) {
            return;
          }
          executeButton.disabled = Boolean(isLoading);
          executeButton.textContent = isLoading ? '実行中…' : '実行';
        }

        function updateRowCount() {
          if (!rowCountLabel) {
            return;
          }
          rowCountLabel.textContent = `行数: ${tableBody.children.length}`;
        }
      })();
    </script>
  </body>
</html>
